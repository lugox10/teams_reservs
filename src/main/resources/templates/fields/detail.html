<!-- src/main/resources/templates/fields/detail.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title th:text="${field.name} ?: 'Detalle de la cancha'">Cancha</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
    <style>
        .hour-btn { min-width:60px; margin:2px; }
        .hour-btn.selected { background:#1976d2; color:#fff; }
        .hour-btn.booked { background:#e57373; color:#fff; cursor:not-allowed; }
        .hour-btn.available { background:#e3f2fd; color:#1976d2; }
    </style>
</head>
<body>
<div th:replace="fragments/navbar :: navbar"></div>
<main class="container py-4">
    <a th:href="@{|/teams-reservs/venues/${venueId}|}" class="btn btn-link mb-3">&larr; Volver al complejo</a>
    <div class="row g-4">
        <div class="col-md-5">
            <img class="img-fluid rounded" th:src="${field.photos != null && !#lists.isEmpty(field.photos) ? field.photos[0] : '/images/placeholder-field.jpg'}" alt="foto cancha"/>
            <div class="mt-3">
                <strong>Ubicación exacta:</strong>
                <span th:text="${venueName}"></span><br/>
                <span th:if="${field.lat != null && field.lng != null}">
                    <a th:href="@{'https://maps.google.com/?q=' + ${field.lat} + ',' + ${field.lng}}" target="_blank">Ver en Google Maps</a>
                </span>
            </div>
        </div>
        <div class="col-md-7">
            <h1 th:text="${field.name}">Cancha</h1>
            <p><strong>Tipo:</strong> <span th:text="${field.fieldType}">Futbol 5</span></p>
            <p><strong>Superficie:</strong> <span th:text="${field.surface}">Sintética</span></p>
            <p><strong>Capacidad:</strong> <span th:text="${field.capacityPlayers}">8</span></p>
            <p><strong>Precio/Hora:</strong> <span th:text="${field.pricePerHour}">25000</span> COP</p>
            <p><strong>Horario:</strong> <span th:text="${field.openHour} + ':00 - ' + ${field.closeHour} + ':00'">06:00 - 23:00</span></p>
            <p><strong>Opciones de pago:</strong>
                <span th:if="${field.allowOnsitePayment}">Pago en sitio </span>
                <span th:if="${field.allowBankTransfer}">| Transferencia bancaria </span>
                <span th:if="${field.allowOnlinePayment}">| Pago online</span>
            </p>
        </div>
    </div>
    <hr class="my-4"/>
    <div class="row">
        <div class="col-md-6">
            <h4>Selecciona la fecha</h4>
            <input type="date" class="form-control mb-3" id="datePicker" th:value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}"/>
        </div>
        <div class="col-md-6">
            <h4>Selecciona la(s) hora(s)</h4>
            <div id="hoursGrid" class="d-flex flex-wrap"></div>
            <div class="mt-2">
                <span id="selectedHours"></span>
            </div>
        </div>
    </div>
    <div class="mt-4">
        <h5>Precio total: <span id="totalPrice">0</span> COP</h5>
        <button class="btn btn-success mt-2" id="reserveBtn" disabled>Reservar ahora</button>
    </div>
    <script>
        let openHour = /*[[${field.openHour}]]*/ 6;
        let closeHour = /*[[${field.closeHour}]]*/ 23;
        let pricePerHour = /*[[${field.pricePerHour}]]*/ 25000;
        let fieldId = /*[[${fieldId}]]*/ 0;
        let selected = [];
        let bookedHours = [];
        function renderHours() {
            const grid = document.getElementById('hoursGrid');
            grid.innerHTML = '';
            selected = [];
            for (let h = openHour; h < closeHour; h++) {
                let btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'hour-btn btn btn-sm me-1 mb-1';
                btn.textContent = (h < 10 ? '0' : '') + h + ':00';
                btn.dataset.hour = h;
                if (bookedHours.includes(h)) {
                    btn.classList.add('booked');
                    btn.disabled = true;
                } else {
                    btn.classList.add('available');
                    btn.onclick = function() {
                        btn.classList.toggle('selected');
                        if (btn.classList.contains('selected')) selected.push(h);
                        else selected = selected.filter(x => x !== h);
                        document.getElementById('selectedHours').textContent = selected.length > 0 ? 'Seleccionadas: ' + selected.map(x => (x < 10 ? '0' : '') + x + ':00').join(', ') : '';
                        document.getElementById('totalPrice').textContent = pricePerHour * selected.length;
                        document.getElementById('reserveBtn').disabled = selected.length === 0;
                    }
                }
                grid.appendChild(btn);
            }
        }
        function fetchAvailability(dateStr) {
            fetch(`/fields/api/fields/${fieldId}/availability?date=${dateStr}`)
                .then(resp => resp.json())
                .then(data => {
                    bookedHours = data;
                    renderHours();
                })
                .catch(() => {
                    bookedHours = [];
                    renderHours();
                });
        }
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('datePicker');
            fetchAvailability(dateInput.value);
            dateInput.addEventListener('change', function() {
                fetchAvailability(this.value);
            });
            document.getElementById('reserveBtn').addEventListener('click', function() {
                if (selected.length === 0) return;
                const date = dateInput.value;
                const startHour = Math.min(...selected);
                const endHour = Math.max(...selected) + 1;
                const startDateTime = date + 'T' + (startHour < 10 ? '0' : '') + startHour + ':00';
                const endDateTime = date + 'T' + (endHour < 10 ? '0' : '') + endHour + ':00';
                const payload = {
                    fieldId: fieldId,
                    startDateTime: startDateTime,
                    endDateTime: endDateTime
                };
                fetch('/reservations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload)
                })
                .then(resp => {
                    if (resp.ok) {
                        alert('Reserva realizada con éxito');
                        window.location.href = '/reservations';
                    } else {
                        resp.text().then(msg => alert('Error al reservar: ' + msg));
                    }
                })
                .catch(() => alert('Error de red al reservar'));
            });
        });
    </script>
</main>
</body>
</html>
