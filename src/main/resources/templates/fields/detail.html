<!-- fields/detail.html -->
<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <title th:text="${field.name} ?: 'Detalle de la cancha'">Cancha</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <style>
        .hour-btn { min-width:60px; margin:2px; }
        .hour-btn.selected { background:#1976d2; color:#fff; }
        .hour-btn.booked { background:#e57373; color:#fff; cursor:not-allowed; }
        .hour-btn.available { background:#e3f2fd; color:#1976d2; }
    </style>
</head>
<body>
<div th:replace="fragments/navbar :: navbar"></div>

<main class="container py-4" style="max-width:1100px;">
    <a th:href="@{|/venues/${venueId}|}" class="btn btn-link mb-3">&larr; Volver al complejo</a>

    <div class="row g-4">
        <div class="col-md-5">
            <img th:src="${field.photos != null && !#lists.isEmpty(field.photos) ? field.photos[0] : '/images/placeholder-field.jpg'}" class="img-fluid rounded"/>
            <div class="mt-3">
                <strong>Ubicación exacta:</strong>
                <div><span th:text="${venueName}"></span></div>
                <div th:if="${field.lat != null && field.lng != null}">
                    <a th:href="@{'https://maps.google.com/?q=' + ${field.lat} + ',' + ${field.lng}}" target="_blank">Ver en Google Maps</a>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <h1 th:text="${field.name}">Cancha</h1>
            <p><strong>Tipo:</strong> <span th:text="${field.fieldType}">Fútbol 5</span></p>
            <p><strong>Superficie:</strong> <span th:text="${field.surface}">Sintética</span></p>
            <p><strong>Precio/Hora:</strong> <span th:text="${field.pricePerHour}">25000</span> COP</p>
            <p><strong>Horario:</strong> <span th:text="${field.openHour} + ':00 - ' + ${field.closeHour} + ':00'">06:00 - 23:00</span></p>
            <p><strong>Opciones de pago:</strong>
                <span th:if="${field.allowOnsitePayment}">Pago en sitio </span>
                <span th:if="${field.allowBankTransfer}">| Transferencia bancaria </span>
                <span th:if="${field.allowOnlinePayment}">| Pago online</span>
            </p>
        </div>
    </div>

    <hr/>

    <div class="row">
        <div class="col-md-6">
            <h5>Selecciona la fecha</h5>
            <input id="datePicker" type="date" class="form-control" th:value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}" />
        </div>
        <div class="col-md-6">
            <h5>Selecciona la(s) hora(s)</h5>
            <div id="hoursGrid" class="d-flex flex-wrap"></div>
            <div class="mt-2"><span id="selectedHours"></span></div>
        </div>
    </div>

    <div class="mt-4">
        <h5>Precio total: <span id="totalPrice">0</span> COP</h5>

        <form id="reservationForm" th:action="@{/reservations}" method="post">
            <input type="hidden" name="fieldId" th:value="${fieldId}" />
            <input type="hidden" name="startDateTime" id="startDateTime" />
            <input type="hidden" name="endDateTime" id="endDateTime" />
            <input type="hidden" name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <div class="mb-2">
                <label>Equipo (opcional)</label>
                <input type="text" name="teamName" class="form-control" />
            </div>
            <div class="mb-2">
                <label>Jugadores</label>
                <input type="number" name="playersCount" min="1" value="1" class="form-control" />
            </div>

            <button type="submit" id="reserveBtn" class="btn btn-success" disabled>Reservar ahora</button>
        </form>
    </div>
</main>

<script>
    let openHour = /*[[${field.openHour}]]*/ 6;
    let closeHour = /*[[${field.closeHour}]]*/ 23;
    let pricePerHour = /*[[${field.pricePerHour}]]*/ 25000;
    let fieldId = /*[[${fieldId}]]*/ 0;
    let selected = [];
    let bookedHours = [];

    const MAX_HOURS_PER_DAY = 2;

    function renderHours() {
      const grid = document.getElementById('hoursGrid');
      grid.innerHTML = '';
      selected = [];
      for (let h = openHour; h < closeHour; h++) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'hour-btn btn btn-sm me-1 mb-1';
        btn.textContent = (h < 10 ? '0' : '') + h + ':00';
        btn.dataset.hour = h;

        if (bookedHours.includes(h)) {
          btn.classList.add('booked');
          btn.disabled = true;
        } else {
          btn.classList.add('available');
          btn.onclick = function() {
            if (!btn.classList.contains('selected')) {
              if (selected.length >= MAX_HOURS_PER_DAY) {
                alert('Máximo ' + MAX_HOURS_PER_DAY + ' horas por día.');
                return;
              }
              // force contiguous selection: if selecting non-adjacent, reset selection
              if (selected.length > 0) {
                const min = Math.min(...selected);
                const max = Math.max(...selected);
                if (h !== min - 1 && h !== max + 1) {
                  selected = [];
                  Array.from(grid.querySelectorAll('.hour-btn.selected')).forEach(n => n.classList.remove('selected'));
                }
              }
              btn.classList.add('selected');
              selected.push(h);
            } else {
              btn.classList.remove('selected');
              selected = selected.filter(x => x !== h);
            }
            updateSelectionUI();
          }
        }
        grid.appendChild(btn);
      }
      updateSelectionUI();
    }

    function updateSelectionUI() {
      document.getElementById('selectedHours').textContent = selected.length > 0 ? 'Seleccionadas: ' + selected.map(x => (x < 10 ? '0' : '') + x + ':00').join(', ') : '';
      document.getElementById('totalPrice').textContent = pricePerHour * selected.length;
      document.getElementById('reserveBtn').disabled = selected.length === 0;
      if (selected.length > 0) {
        const startHour = Math.min(...selected);
        const endHour = Math.max(...selected) + 1;
        const date = document.getElementById('datePicker').value;
        document.getElementById('startDateTime').value = date + 'T' + (startHour < 10 ? '0' : '') + startHour + ':00';
        document.getElementById('endDateTime').value = date + 'T' + (endHour < 10 ? '0' : '') + endHour + ':00';
      } else {
        document.getElementById('startDateTime').value = '';
        document.getElementById('endDateTime').value = '';
      }
    }

    function fetchAvailability(dateStr) {
      fetch(`/fields/${fieldId}/availability?date=${dateStr}`)
        .then(r => r.json())
        .then(data => { bookedHours = data; renderHours(); })
        .catch(() => { bookedHours = []; renderHours(); });
    }

    document.addEventListener('DOMContentLoaded', function() {
      const dateInput = document.getElementById('datePicker');
      fetchAvailability(dateInput.value);
      dateInput.addEventListener('change', function() { fetchAvailability(this.value); });
    });
</script>
</body>
</html>
