<!-- src/main/resources/templates/reserv-users/form.html -->
<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <title th:text="${editingId != null ? 'Editar reserva' : 'Nueva reserva'}">Nueva reserva</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="p-4">
<div class="container">
    <h1 th:text="${editingId != null ? 'Editar reserva' : 'Nueva reserva'}">Nueva reserva</h1>

    <!-- Mensajes flash simples -->
    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <div class="card">
        <div class="card-body">
            <form th:action="${editingId != null} ? @{/reservations/{id}(id=${editingId})} : @{/reservations}"
                  th:object="${reservation}"
                  method="post" novalidate>

                <!-- CSRF token -->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <!-- Hidden fields for legacy/lookup -->
                <input type="hidden" th:field="*{userName}" />
                <input type="hidden" th:field="*{userId}" />

                <!-- VENUE -->
                <div class="mb-3">
                    <label class="form-label">Venue</label>
                    <select id="venueSelect" name="venueId" th:field="*{venueId}" class="form-select" onchange="onVenueChange()">
                        <option value="">-- seleccionar --</option>
                        <option th:each="v : ${venues}"
                                th:value="${v.id}"
                                th:text="${v.name}"
                                th:selected="${reservation.venueId} != null and reservation.venueId == v.id">
                        </option>
                    </select>
                    <div class="text-danger small" th:if="${#fields.hasErrors('venueId')}" th:errors="*{venueId}"></div>
                </div>

                <!-- FIELD -->
                <div class="mb-3">
                    <label class="form-label">Campo</label>
                    <select id="fieldSelect" name="fieldId" th:field="*{fieldId}" class="form-select" onchange="onFieldChange()">
                        <option value="">-- seleccionar --</option>
                        <option th:each="f : ${fields}"
                                th:value="${f.id}"
                                th:text="${f.name}"
                                th:selected="${reservation.fieldId} != null and reservation.fieldId == f.id">
                        </option>
                    </select>
                    <div class="text-danger small" th:if="${#fields.hasErrors('fieldId')}" th:errors="*{fieldId}"></div>
                </div>

                <!-- TIMESLOT (opcional) -->
                <div class="mb-3">
                    <label class="form-label">Time slot (opcional)</label>
                    <select id="timeslotSelect" name="timeSlotId" th:field="*{timeSlotId}" class="form-select" onchange="onTimeSlotSelected()">
                        <option value="">-- seleccionar --</option>
                        <option th:each="ts : ${timeSlots}"
                                th:value="${ts.id}"
                                th:selected="${reservation.timeSlotId} != null and reservation.timeSlotId == ts.id"
                                th:text="${#temporals.format(ts.startDateTime,'yyyy-MM-dd HH:mm') + ' - ' + #temporals.format(ts.endDateTime,'HH:mm')}">
                        </option>
                    </select>
                    <div class="form-text">Si eliges un time slot, se ignoran Start / End / Duración.</div>
                    <div class="text-danger small" th:if="${#fields.hasErrors('timeSlotId')}" th:errors="*{timeSlotId}"></div>
                </div>

                <div class="row">
                    <!-- START -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Start</label>
                        <input type="datetime-local"
                               name="startDateTime"
                               th:field="*{startDateTime}"
                               class="form-control"/>
                        <div class="text-danger small" th:if="${#fields.hasErrors('startDateTime')}" th:errors="*{startDateTime}"></div>
                    </div>

                    <!-- END -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">End (opcional si usas duración)</label>
                        <input type="datetime-local"
                               name="endDateTime"
                               th:field="*{endDateTime}"
                               class="form-control"/>
                        <div class="text-danger small" th:if="${#fields.hasErrors('endDateTime')}" th:errors="*{endDateTime}"></div>
                    </div>
                </div>

                <div class="row">
                    <!-- DURATION -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Duración (minutos)</label>
                        <input type="number"
                               name="durationMinutes"
                               th:field="*{durationMinutes}"
                               class="form-control"
                               min="1" max="60"/>
                        <div class="form-text">Sin time slot: se usa Start + Duración. Máx 60 minutos.</div>
                        <div class="text-danger small" th:if="${#fields.hasErrors('durationMinutes')}" th:errors="*{durationMinutes}"></div>
                    </div>

                    <!-- PLAYERS -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Players count</label>
                        <input type="number"
                               name="playersCount"
                               th:field="*{playersCount}"
                               class="form-control"
                               min="1"/>
                        <div class="text-danger small" th:if="${#fields.hasErrors('playersCount')}" th:errors="*{playersCount}"></div>
                    </div>

                    <!-- CREATE TEAMS MATCH -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Crear partido TeamsFC</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" th:field="*{createTeamsMatch}" id="createTeamsMatch"/>
                            <label class="form-check-label" for="createTeamsMatch">Crear match automáticamente</label>
                        </div>
                    </div>
                </div>

                <!-- TEAM NAME -->
                <div class="mb-3">
                    <label class="form-label">Team name (opcional)</label>
                    <input type="text" name="teamName" th:field="*{teamName}" class="form-control" />
                </div>

                <!-- GUEST vs USER block -->
                <div class="mb-3">
                    <!-- Si el backend marcó isAuthenticated=true, se asume user logueado y ocultamos guest -->
                    <div th:if="${isAuthenticated == true}">
                        <p class="text-muted">Estás logueado como <strong th:text="${reservation.userName}">user</strong>. Si quieres reservar como invitado, desloguea o edita aquí.</p>
                    </div>

                    <div th:if="${isAuthenticated != true}">
                        <h5>Datos del invitado</h5>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Nombre</label>
                                <input type="text" name="guestName" th:field="*{guestName}" class="form-control"/>
                                <div class="text-danger small" th:if="${#fields.hasErrors('guestName')}" th:errors="*{guestName}"></div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Teléfono</label>
                                <input type="text" name="guestPhone" th:field="*{guestPhone}" class="form-control"/>
                                <div class="text-danger small" th:if="${#fields.hasErrors('guestPhone')}" th:errors="*{guestPhone}"></div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" name="guestEmail" th:field="*{guestEmail}" class="form-control"/>
                                <div class="text-danger small" th:if="${#fields.hasErrors('guestEmail')}" th:errors="*{guestEmail}"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NOTES -->
                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <textarea name="notes" th:field="*{notes}" class="form-control" rows="3"></textarea>
                </div>

                <div class="mb-3">
                    <button class="btn btn-primary" type="submit">Guardar</button>
                    <a href="/reservations" class="btn btn-secondary">Cancelar</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    async function onVenueChange() {
        const venueId = document.getElementById('venueSelect').value;
        if (!venueId) {
            clearSelect('fieldSelect');
            clearSelect('timeslotSelect');
            return;
        }
        const res = await fetch('/reservations/api/fields?venueId=' + venueId);
        const fields = await res.json();
        populateSelect('fieldSelect', fields);
        clearSelect('timeslotSelect');
    }

    async function onFieldChange() {
        const fieldId = document.getElementById('fieldSelect').value;
        if (!fieldId) {
            clearSelect('timeslotSelect');
            return;
        }
        const res = await fetch('/reservations/api/timeslots?fieldId=' + fieldId);
        const slots = await res.json();
        // slots expected to contain startDateTime/endDateTime in ISO format
        const ts = slots.map(s => ({ id: s.id, text: new Date(s.startDateTime).toLocaleString() + ' - ' + new Date(s.endDateTime).toLocaleTimeString()}));
        populateSelect('timeslotSelect', ts);
    }

    function clearSelect(id) {
        const sel = document.getElementById(id);
        if (!sel) return;
        sel.innerHTML = '<option value="">-- seleccionar --</option>';
    }

    function populateSelect(id, items) {
        const sel = document.getElementById(id);
        if (!sel) return;
        sel.innerHTML = '<option value="">-- seleccionar --</option>';
        items.forEach(i => {
            const opt = document.createElement('option');
            opt.value = i.id;
            opt.text = i.name ? i.name : i.text;
            sel.appendChild(opt);
        });
    }

    function onTimeSlotSelected() {
        // Si quieres autocopiar start/end desde el timeslot seleccionado, haz una consulta adicional aquí
    }
</script>
</body>
</html>
